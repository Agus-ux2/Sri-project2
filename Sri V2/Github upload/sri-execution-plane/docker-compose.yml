version: '3.8'

services:
  # Worker con sandbox y restricciones de red
  worker:
    build: .
    container_name: sri-worker-1
    restart: unless-stopped
    
    # SEGURIDAD: Usuario no-root
    user: "1001:1001"
    
    # SEGURIDAD: Read-only filesystem
    read_only: true
    
    # SEGURIDAD: Capabilities mínimas
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    # SEGURIDAD: Security options
    security_opt:
      - no-new-privileges:true
    
    # Volumes temporales (writable)
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=512m
      - /app/temp:rw,noexec,nosuid,size=256m
      - /app/logs:rw,noexec,nosuid,size=256m
    
    # Variables de entorno
    environment:
      - NODE_ENV=production
      - WORKER_ID=worker-1
      - REDIS_URL=redis://redis:6379
      - S3_ENDPOINT=http://minio:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-minioadmin}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-minioadmin}
      - S3_SCRIPTS_BUCKET=sri-scripts
      - S3_RESULTS_BUCKET=sri-results
      - SCRIPT_SIGNING_SECRET=${SCRIPT_SIGNING_SECRET}
      - LOG_LEVEL=info
    
    # Red interna SOLO (sin acceso a internet)
    networks:
      - sri-internal
    
    # Depende de Redis y S3
    depends_on:
      - redis
      - minio
    
    # Límites de recursos
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis (solo para workers, no expuesto)
  redis:
    image: redis:7-alpine
    container_name: sri-redis-worker
    networks:
      - sri-internal
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    container_name: sri-minio
    networks:
      - sri-internal
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MinIO Client (para crear buckets iniciales)
  minio-init:
    image: minio/mc:latest
    container_name: sri-minio-init
    networks:
      - sri-internal
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 ${S3_ACCESS_KEY:-minioadmin} ${S3_SECRET_KEY:-minioadmin};
      mc mb myminio/sri-scripts --ignore-existing;
      mc mb myminio/sri-results --ignore-existing;
      echo 'Buckets created successfully';
      exit 0;
      "

networks:
  # Red interna SIN acceso a internet
  sri-internal:
    driver: bridge
    internal: true

volumes:
  redis_data:
  minio_data:
